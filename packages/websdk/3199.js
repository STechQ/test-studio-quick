"use strict";(this.webpackChunk_stechquick_websdk=this.webpackChunk_stechquick_websdk||[]).push([[3199],{13199:(e,t,n)=>{n.r(t),n.d(t,{default:()=>f});var s=function(){var e=this.$createElement;return(this._self._c||e)("div")};s._withStripped=!0;var a=n(62190),o=n(6422),r=n(89146),i=n(1945),c=n(70715),u=function(e,t,n,s){return new(n||(n=Promise))((function(a,o){function r(e){try{c(s.next(e))}catch(e){o(e)}}function i(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,i)}c((s=s.apply(e,t||[])).next())}))},l=function(e,t){var n,s,a,o,r={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function i(o){return function(i){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,s&&(a=2&o[0]?s.return:o[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,o[1])).done)return a;switch(s=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return r.label++,{value:o[1],done:!1};case 5:r.label++,s=o[1],o=[0];continue;case 7:o=r.ops.pop(),r.trys.pop();continue;default:if(!((a=(a=r.trys).length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){r=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){r.label=o[1];break}if(6===o[0]&&r.label<a[1]){r.label=a[1],a=o;break}if(a&&r.label<a[2]){r.label=a[2],r.ops.push(o);break}a[2]&&r.ops.pop(),r.trys.pop();continue}o=t.call(e,r)}catch(e){o=[6,e],s=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,i])}}};const h=r.default.extend({name:"LiveConnection",props:{url:{type:String,default:""},secure:{type:Boolean,default:!1},message:{type:[Object,String],default:""},urlParams:{type:Object,default:function(){}},enableIamAuth:{type:Boolean,default:!1},sendQueueMessage:{type:Boolean,default:!0},autoConnect:{type:Boolean,default:!1},reconnect:{type:Boolean,default:!1},reconnectInterval:{type:Number,default:60},reconnectBackOff:{type:Boolean,default:!1},_renderingProps:{type:Object,default:{isEditMode:{type:Boolean,default:!1}}}},data:function(){return this.$props.sendQueueMessage=!1!==this.$props.sendQueueMessage,{typeHelper:new o.O,seqErrCount:0,connection:{readyState:WebSocket.CLOSED,close:function(){}},urlData:this.$props.url,urlParamsData:this.$props.urlParams,messageData:this.$props.message,messageRequestList:[],timerID:0,reconectTryCount:0,reason:"",onConnectionReason:{connectionError:"ConnectionError",connectionClose:"ConnectionClose",userSend:"UserSend",autoConnect:"AutoConnect"}}},methods:{Send:function(e,t){var n=this.onConnectionReason.userSend;this.SendMessage(n,e,t)},SendMessage:function(e,t,n){var s=this;if(t&&(this.messageData=t),this.messageData){var a;a=this.typeHelper.isString(this.messageData)?this.messageData:JSON.stringify(this.messageData),this._connect(e,(function(){s.connection.send(a)}),n)}else this._connect(e)},Close:function(){if(!this._renderingProps.isEditMode){this.connection.close();var e=i.B.settingsWrapper.settings.minEngineLogLevel?a.h[i.B.settingsWrapper.settings.minEngineLogLevel]:void 0;a.Y.Log({logMessage:"[ LiveConnection has closed ][Url: "+this.urlData+" ] ",minEngineLogLevel:e})}},_connect:function(e,t,n){var s=this;if(!s._renderingProps.isEditMode){switch(this.connection.readyState){case WebSocket.OPEN:return void(t&&t());case WebSocket.CLOSED:this.urlParamsData=n||this.urlParamsData;break;case WebSocket.CLOSING:return;case WebSocket.CONNECTING:return void(t&&this.messageRequestList.push(t))}s._regulateUrl(),s.connection=new WebSocket(s.urlData),s.reason=e,s.connection.onopen=function(e){var n,a;return u(this,void 0,void 0,(function(){var e;return l(this,(function(o){switch(o.label){case 0:return s.seqErrCount=0,s.enableIamAuth?[4,null===(n=c.WebSDK.getPlateauIAM())||void 0===n?void 0:n.refreshPromise()]:[3,2];case 1:o.sent(),(e=null===(a=c.WebSDK.getPlateauIAM())||void 0===a?void 0:a.getToken())&&s.connection.send(JSON.stringify({token:e})),o.label=2;case 2:return s.$emit("onConnectionOpen",s.reason),t&&t(),s.sendQueueMessage&&s.messageRequestList&&s.messageRequestList.map((function(e){return e()})),this.reconectTryCount=0,[2]}}))}))},s.connection.onerror=function(e){var t=s.onConnectionReason.connectionError;s.seqErrCount++,s.$emit("onError",e,s.seqErrCount),s.connection.readyState==WebSocket.CLOSED&&1==s.reconnect&&s._reConnect(t)},s.connection.onmessage=function(e){var t;return u(this,void 0,void 0,(function(){var n;return l(this,(function(a){switch(a.label){case 0:return s.enableIamAuth?[4,null===(t=c.WebSDK.getPlateauIAM())||void 0===t?void 0:t.refreshPromise()]:[3,2];case 1:a.sent(),a.label=2;case 2:return"",n=s.typeHelper.isJsonString(e.data)?JSON.parse(e.data):e.data,s.$emit("onMessageReceived",n),[2]}}))}))},s.connection.onclose=function(e){var t=s.onConnectionReason.connectionClose;s.$emit("onClose",e),1==s.reconnect&&s._reConnect(t)}}},_regulateUrl:function(){if(this.urlData=this.url,this.urlData.startsWith("ws")&&null==this.secure)this.urlData;else{this.urlData.startsWith("ws")?this.urlData=this.urlData.split("//")[1]:this.urlData.startsWith("/")&&(this.urlData=this.urlData.substring(1));var e="ws://";this.secure&&(e="wss://"),this.urlData=e.concat(this.urlData)}this._setUrlParams()},_setUrlParams:function(){for(var e in this.urlParams)this.urlData=this.urlData.replace("#"+e+"#",this.urlParams[e])},_calculateReconnectInterval:function(e){var t=e;if(this.reconnectBackOff){var n=[1,2,3,5,8,13,21],s=e/5,a=this.reconectTryCount>n.length?n[n.length-1]:n[this.reconectTryCount-1];t=Math.round(s*a)}return t},_reConnect:function(e){var t=this;this.reconectTryCount++;var n=this._calculateReconnectInterval(this.reconnectInterval);this.timerID=window.setTimeout((function(){delete t.timerID,t.sendQueueMessage||(t.messageData=void 0),t.SendMessage(e)}),1e3*n)}},mounted:function(){if(this.autoConnect){var e=this.onConnectionReason.autoConnect;this._connect(e)}},destroyed:function(){this.Close()},computed:{message:{get:function(){return this.messageData},set:function(e){this.messageData=e}},urlParams:{get:function(){return this.urlParamsData},set:function(e){this.urlParamsData=e}}}}),f=(0,n(62264).Z)(h,s,[],!1,null,null,null).exports}}]);